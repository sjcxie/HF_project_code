---
title: "GBTM_data_processing_diagnosis"
author: "Jinchen Xie"
date: "6/15/2020"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
library(tidyverse)
library(knitr)
library(readxl)
library(openxlsx)
library(data.table)
library(Hmisc)
library(magrittr)
```


# import admission dataset

The dataset used is admission withou 30% NA tolerance. 
```{r}
admission_30NA <- read_excel("~/Desktop/datasets/processed/Filtered Attributes Admission.xlsx", sheet = 'NA2030_filtered_admission')

admission_flags <- admission_30NA %>% 
  select(rID, ends_with("FLAG"), starts_with("READMISSION"))
```

# only >=3 readmissions
```{r}
# readmission_counts <- admission_flags %>% group_by(rID) %>% tally()
# sub_3to15_rID <- readmission_counts[which(readmission_counts$n>2),]$rID
# admission_flags.3to15 <- admission_flags[which(admission_flags$rID %in% sub_3to15_rID),]
```

```{r}
admission_flags.3to15 <- admission_flags[which(admission_flags$rID %in% patients_id),]
```



**How many times each diagnosis code appear in the dataset?**

```{r}
colSums(admission_flags.3to15[,c(-1, -14,-15)])

```

**How many patients had been diagnosed with each diagnosis code?**

```{r}
col.list <- colnames(admission_flags.3to15)[c(-1, -15, -14)]
for (val in col.list){
  cat(val,": ", length(unique(admission_flags.3to15[which(admission_flags.3to15[[val]]==1),]$rID)), "   ", length(unique(admission_flags.3to15[which(admission_flags.3to15[[val]]==1),]$rID))/length(unique(admission_flags.3to15$rID)),"\n")
}
```




# Reshape for traj model input

```{r}
generate_col_names <- function(measure_name, patients_id){
  col_names <- c()
  for (val in patients_id){
    col_names <- append(col_names, paste(measure_name, val, sep="_"))
  }
 return(col_names) 
}

measurement_df <- function(orginial_df, new_df, measure_name){
  col.names <- generate_col_names(measure_name, patients_id)
  names(new_df) <- col.names
  
  for (val in seq(1, length(unique(admission_flags.3to15$rID)))){
    temp_c <- orginial_df[[measure_name]][which(orginial_df$rID == patients_id[val])]
    new_df[[col.names[val]]] <- c(temp_c, rep(NA, nrow(new_df)-length(temp_c)))
  }
  
  return(new_df)
}

change_col_names <- function(measure_name){
  col_names <- c()
  for (val in seq(1,15)){
    col_names <- append(col_names, paste(measure_name, val, sep="_"))
  }
  return(col_names)
}
```

## number of readmissions
```{r}
time.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))
names(time.df) <- generate_col_names('T', patients_id)

for (val in seq(1, length(unique(admission_flags.3to15$rID)))){
    time.df[[names(time.df)[val]]] <- seq(1,15)
}

time.df.t <- transpose(time.df)
names(time.df.t) <- change_col_names('T')

```

## NONCARDIACFLAG
```{r}

nc.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

nc.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = nc.df, measure_name = 'NONCARDIACFLAG')

nc.df.t <- transpose(nc.df)

names(nc.df.t) <- change_col_names('NONCARDIACFLAG')
```

## CARDIACFLAG
```{r}

c.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

c.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = c.df, measure_name = 'CARDIACFLAG')

c.df.t <- transpose(c.df)

names(c.df.t) <- change_col_names('CARDIACFLAG')
```

## MIFLAG
```{r}

mi.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

mi.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = mi.df, measure_name = 'MIFLAG')

mi.df.t <- transpose(mi.df)

names(mi.df.t) <- change_col_names('MIFLAG')
```


## HFFLAG
```{r}
hf.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

hf.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = hf.df, measure_name = 'HFFLAG')

hf.df.t <- transpose(hf.df)

names(hf.df.t) <- change_col_names('HFFLAG')
```


## BLEEDFLAG
```{r}
bl.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

bl.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = bl.df, measure_name = 'BLEEDFLAG')

bl.df.t <- transpose(bl.df)

names(bl.df.t) <- change_col_names('BLEEDFLAG')
```



## AFIBFLAG
```{r}
afi.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

afi.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = afi.df, measure_name = 'AFIBFLAG')

afi.df.t <- transpose(afi.df)

names(afi.df.t) <- change_col_names('AFIBFLAG')
```

## CKDFLAG
```{r}
ckd.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

ckd.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = ckd.df, measure_name = 'CKDFLAG')

ckd.df.t <- transpose(ckd.df)

names(ckd.df.t) <- change_col_names('CKDFLAG')
```


## VTACHFLAG
```{r}
vt.df <- data.frame(matrix(ncol = length(unique(admission_flags.3to15$rID)), nrow = 15))

vt.df <- measurement_df(orginial_df = admission_flags.3to15, new_df = vt.df, measure_name = 'VTACHFLAG')

vt.df.t <- transpose(vt.df)

names(vt.df.t) <- change_col_names('VTACHFLAG')
```


# save dataset

```{r}
combined.flags.time <- cbind(patients_id,nc.df.t, c.df.t, mi.df.t,bl.df.t,afi.df.t,ckd.df.t,vt.df.t, hf.df.t, time.df.t)
write.xlsx(combined.flags.time, '~/Desktop/datasets/processed/GBTM_data/flags gbtm data.xlsx', col.names = TRUE, row.names = FALSE)
```