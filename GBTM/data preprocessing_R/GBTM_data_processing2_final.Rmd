---
title: "GBTM_data_processing2"
author: "Jinchen Xie"
date: "6/12/2020"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
library(tidyverse)
library(knitr)
library(readxl)
library(openxlsx)
library(data.table)
library(Hmisc)
```

# import admission dataset

The dataset used is admission withou 30% NA tolerance. 
```{r}
admission_30NA <- read_excel("~/Desktop/datasets/processed/Filtered Attributes Admission.xlsx", sheet = 'NA2030_filtered_admission')
```

We are only interested in the continuous lab measurements here. **New dataset: admission_lab**
```{r}
names(admission_30NA)[names(admission_30NA) == "READMISSION_DAYS"] <- "DAYS_READMISSION"

admission_lab <- 
  select(admission_30NA, -ends_with("_DAYS")) %>% 
  select(rID, DAYS_READMISSION, readmission_days_btw, WBC:HCT)

names(admission_lab)[names(admission_lab) == "NA"] <- "N_A"

admission_lab$DAYS_READMISSION[which(is.na(admission_lab$DAYS_READMISSION))] <- 0
```

```{r}
write.xlsx(admission_lab, '~/Desktop/datasets/processed/GBTM_data/Original_Labs_Data.xlsx', col.names = TRUE, row.names = FALSE)
```



```{r}
summary(admission_lab)
```




# Data Transformation





## WBC 

```{r}
measure = "WBC"
admission.wbc <- admission_lab
summary(admission_lab[[measure]])
```

**Normal range of WBC is 4-11. **

```{r}
dim(admission_lab[which(admission_lab$WBC > 40),])
admission.wbc[[measure]][which(admission_lab[[measure]]> 40)]  <- NA_real_
```


```{r}
ggplot(data = admission.wbc, aes(WBC)) + geom_histogram()
# qqnorm(admission.wbc$WBC, pch = 1, frame = FALSE)
# qqline(admission.wbc$WBC, col = "steelblue", lwd = 2)
# ks.test(x=admission.wbc$WBC, y='pnorm', mean=mean(admission.wbc$WBC, na.rm=TRUE), sd=sd(admission.wbc$WBC, na.rm=TRUE))
```

*p-value of ks test is << 0.01, data distribution is significantly different from normal distribution.*


```{r}

# bestNormalize::boxcox(admission.wbc$WBC)

# admission.wbc$WBC <- sqrt(admission.wbc$WBC)
ggplot(data = admission.wbc, aes(WBC)) + geom_histogram()
```

```{r}
admission_lab <- admission.wbc

```



## HGB

```{r}
measure = "HGB"
admission.hgb <- admission_lab
summary(admission_lab[[measure]])
ggplot(data = admission.hgb, aes(HGB)) + geom_histogram()
```

```{r}
admission_lab <- admission.hgb
summary(admission_lab$HGB)
```


## EGFR
```{r}
measure = "EGFR"
admission.egfr <- admission_lab
summary(admission_lab[[measure]])
ggplot(data = admission.egfr, aes(EGFR)) + geom_histogram()
```

```{r}
### Remove outliers
dim(admission_lab[which(admission_lab$EGFR > 200),])
admission.egfr[[measure]][which(admission_lab[[measure]]> 200)]  <- NA_real_
ggplot(data = admission.egfr, aes(EGFR)) + geom_histogram()
```

```{r}
# admission.egfr$EGFR <- sqrt(admission.egfr$EGFR)
# ggplot(data = admission.egfr, aes(EGFR)) + geom_histogram()
```

```{r}
admission_lab <- admission.egfr
```




## K
```{r}
measure = "K"
admission.k <- admission_lab
summary(admission_lab[[measure]])
ggplot(data = admission.k, aes(K)) + geom_histogram()
```

```{r}
# admission.k$K <- sqrt(admission.k$K)
ggplot(data = admission.k, aes(K)) + geom_histogram()
```
```{r}
admission_lab <- admission.k
```




## N_A
```{r}
measure = "N_A"
admission.na <- admission_lab
summary(admission_lab[[measure]])
ggplot(data = admission.na, aes(N_A)) + geom_histogram()
```


```{r}
admission_lab <- admission.na
```


## GLUCOSE
```{r}
measure = "GLUCOSE"
admission.glucose <- admission_lab
summary(admission_lab[[measure]])
ggplot(data = admission.glucose, aes(GLUCOSE)) + geom_histogram()
```
```{r}
dim(admission_lab[which(admission_lab$GLUCOSE > 600),])
admission.glucose[[measure]][which(admission_lab[[measure]]> 600)]  <- NA_real_
ggplot(data = admission.glucose, aes(GLUCOSE)) + geom_histogram()
```


```{r}
admission.glucose[[measure]] <- log10(admission.glucose[[measure]])

ggplot(data = admission.glucose, aes(GLUCOSE)) + geom_histogram() + xlab("log10(glucose)")
```


```{r}
# normalize <- function(x) {
#   return ((x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE)))
# }
# admission.glucose[[measure]] <- normalize(admission.glucose[[measure]])
# ggplot(data = admission.glucose, aes(GLUCOSE)) + geom_histogram() 
```




```{r}
admission_lab <- admission.glucose
```


## PLATELETS

```{r}
measure = "PLATELETS"
admission.platelet <- admission_lab
summary(admission_lab[[measure]])
ggplot(data = admission.platelet, aes(PLATELETS)) + geom_histogram()
```

```{r}
dim(admission_lab[which(admission_lab$PLATELETS > 600),])
admission.platelet[[measure]][which(admission_lab[[measure]]> 600)]  <- NA_real_
ggplot(data = admission.platelet, aes(PLATELETS)) + geom_histogram()
```


```{r}
# admission.platelet[[measure]] <- sqrt(admission.platelet[[measure]])
ggplot(data = admission.platelet, aes(PLATELETS)) + geom_histogram()
```

```{r}
admission_lab <- admission.platelet
```


## HCT

```{r}
measure = "HCT"
admission.hct <- admission_lab
summary(admission_lab[[measure]])
ggplot(data = admission.hct, aes(HCT)) + geom_histogram()
```

```{r}
admission_lab <- admission.hct
```


## DAYS_READMISSION

```{r}
# measure = "readmission_days_btw"
# admission.days <- admission_lab
# summary(admission_lab[[measure]])
# ggplot(data = admission.days, aes(readmission_days_btw)) + geom_histogram()
```






```{r}
rm(admission.wbc, admission.egfr, admission.hgb, admission.k, admission.na, admission.glucose, admission.platelet, admission.hct)
rm(iqr, Q, measure)
```

# only >=3 readmissions
```{r}
readmission_counts <- admission_lab %>% group_by(rID) %>% tally()
sub_3to15_rID <- readmission_counts[which(readmission_counts$n>2),]$rID

admission_lab.3to15 <- admission_lab[which(admission_lab$rID %in% sub_3to15_rID),]
```


# allow missing at random
```{r}
list_remove <- c()
# for each patient exist in the admission_lab.3to5 subset:
for (id in sub_3to15_rID){
  sub.df <- admission_lab.3to15[which(admission_lab.3to15$rID == id),]
  
  num_wbc <- dim(sub.df[-which(is.na(sub.df$WBC)),])[1]
  na_wbc <- dim(sub.df[which(is.na(sub.df$WBC)),])[1]
  num_hgb <- dim(sub.df[-which(is.na(sub.df$HGB)),])[1]
  na_hgb <- dim(sub.df[which(is.na(sub.df$HGB)),])[1]
  num_egfr <- dim(sub.df[-which(is.na(sub.df$EGFR)),])[1]
  na_egfr <- dim(sub.df[which(is.na(sub.df$EGFR)),])[1]
  num_k <- dim(sub.df[-which(is.na(sub.df$K)),])[1]
  na_k <- dim(sub.df[which(is.na(sub.df$K)),])[1]
  num_na <- dim(sub.df[-which(is.na(sub.df$N_A)),])[1]
  na_na <- dim(sub.df[which(is.na(sub.df$N_A)),])[1]
  num_glucose <- dim(sub.df[-which(is.na(sub.df$GLUCOSE)),])[1]
  na_glucose <- dim(sub.df[which(is.na(sub.df$GLUCOSE)),])[1]
  num_platelets <- dim(sub.df[-which(is.na(sub.df$PLATELETS)),])[1]
  na_platelets <- dim(sub.df[which(is.na(sub.df$PLATELETS)),])[1]
  num_hct <- dim(sub.df[-which(is.na(sub.df$HCT)),])[1]
  na_hct <- dim(sub.df[which(is.na(sub.df$HCT)),])[1]
  
  
  
  if (((num_wbc<3) & (na_wbc!=0)) | ((num_hgb<3) & (na_hgb!=0))  | ((num_egfr<3) & (na_egfr!=0)) |  ((num_k<3) & (na_k!=0)) | ((num_na<3) & (na_na!=0)) | ((num_glucose<3) & (na_glucose!=0)) | ((num_platelets<3) & (na_platelets!=0)) | ((num_platelets<3) & (na_hct!=0))){
    list_remove <- append(list_remove, id)
  }else{
    next
  }
}


admission_lab.NArandom <- admission_lab.3to15[-which(admission_lab.3to15$rID %in% list_remove),]
chosen_rID <- unique(admission_lab.NArandom$rID)
```

```{r}
rm(num_wbc,na_wbc,num_hgb ,na_hgb,num_egfr,na_egfr,num_k,na_k, num_na, na_na, num_glucose, na_glucose, na_platelets, num_platelets, na_hct)
rm(id, sub_3to15_rID, sub.df, readmission_counts, list_remove)
```





# Reshape for traj model input

```{r}
patients_id <- unique(admission_lab.NArandom$rID)

generate_col_names <- function(measure_name, patients_id){
  col_names <- c()
  for (val in patients_id){
    col_names <- append(col_names, paste(measure_name, val, sep="_"))
  }
 return(col_names) 
}

measurement_df <- function(orginial_df, new_df, measure_name){
  col.names <- generate_col_names(measure_name, patients_id)
  names(new_df) <- col.names
  
  for (val in seq(1, length(unique(admission_lab.NArandom$rID)))){
    temp_c <- orginial_df[[measure_name]][which(orginial_df$rID == patients_id[val])]
    new_df[[col.names[val]]] <- c(temp_c, rep(NA, nrow(new_df)-length(temp_c)))
  }
  
  return(new_df)
}

change_col_names <- function(measure_name){
  col_names <- c()
  for (val in seq(1,15)){
    col_names <- append(col_names, paste(measure_name, val, sep="_"))
  }
  return(col_names)
}
```



*WBC*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
wbc.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

wbc.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = wbc.df, measure_name = 'WBC')

wbc.df.t <- transpose(wbc.df)

names(wbc.df.t) <- change_col_names('WBC')
```

*HGB*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
hgb.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

hgb.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = hgb.df, measure_name = 'HGB')

hgb.df.t <- transpose(hgb.df)

names(hgb.df.t) <- change_col_names('HGB')
```

*EGFR*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
egfr.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

egfr.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = egfr.df, measure_name = 'EGFR')

egfr.df.t <- transpose(egfr.df)

names(egfr.df.t) <- change_col_names('EGFR')
```

*K*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
k.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

k.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = k.df, measure_name = 'K')

k.df.t <- transpose(k.df)

names(k.df.t) <- change_col_names('K')
```

*N_A*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
n_a.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

n_a.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = n_a.df, measure_name = 'N_A')

n_a.df.t <- transpose(n_a.df)

names(n_a.df.t) <- change_col_names('N_A')
```

*GLUCOSE*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
glucose.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

glucose.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = glucose.df, measure_name = 'GLUCOSE')

glucose.df.t <- transpose(glucose.df)

names(glucose.df.t) <- change_col_names('GLUCOSE')
```



*PLATELETS*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
platelets.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

platelets.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = platelets.df, measure_name = 'PLATELETS')

platelets.df.t <- transpose(platelets.df)

names(platelets.df.t) <- change_col_names('PLATELETS')
```


*HCT*
```{r}
# wbc_ob <- complete.labs.3to15 %>% select(rID, WBC)
hct.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))

hct.df <- measurement_df(orginial_df = admission_lab.NArandom, new_df = hct.df, measure_name = 'HCT')

hct.df.t <- transpose(hct.df)

names(hct.df.t) <- change_col_names('HCT')
```



## number of readmissions
```{r}
time.df <- data.frame(matrix(ncol = length(unique(admission_lab.NArandom$rID)), nrow = 15))
names(time.df) <- generate_col_names('T', patients_id)

for (val in seq(1, length(unique(admission_lab.NArandom$rID)))){
    time.df[[names(time.df)[val]]] <- seq(1,15)
}

time.df.t <- transpose(time.df)
names(time.df.t) <- change_col_names('T')

```



```{r}
rm(egfr.df, wbc.df, hgb.df, k.df, n_a.df, glucose.df, hct.df, platelets.df, time.df)
# rm(val, patients_id, generate_col_names, measurement_df, change_col_names)
```


```{r}
patients.id <- unique(admission_lab.NArandom$rID)
```



# save dataset

```{r}
combined.labs.time <- cbind(patients.id, wbc.df.t, hgb.df.t, egfr.df.t, k.df.t, n_a.df.t, glucose.df.t, platelets.df.t, hct.df.t, time.df.t)
write.xlsx(combined.labs.time, '~/Desktop/datasets/processed/GBTM_data/combined gbtm data v2.xlsx', col.names = TRUE, row.names = FALSE)
```



```{r}
# combined.labs.time <- cbind(patients.id, wbc.df.t, hgb.df.t, egfr.df.t, k.df.t, n_a.df.t, glucose.df.t, platelets.df.t, hct.df.t, time.df.t)
# write.xlsx(combined.labs.time, '~/Desktop/datasets/processed/GBTM_data/combined gbtm data v1.xlsx', col.names = TRUE, row.names = FALSE)
```










# dataset characteristics
```{r}
summary(admission_lab.NArandom$WBC)
ggplot(data = admission_lab.NArandom, aes(WBC)) + geom_histogram()
```

```{r}
summary(admission_lab.NArandom$EGFR)
ggplot(data = admission_lab.NArandom, aes(EGFR)) + geom_histogram()
```


```{r}
summary(admission_lab.NArandom$K)
ggplot(data = admission_lab.NArandom, aes(K)) + geom_histogram()
```

```{r}
summary(admission_lab.NArandom$GLUCOSE)
ggplot(data = admission_lab.NArandom, aes(GLUCOSE)) + geom_histogram()
```

```{r}
summary(admission_lab.NArandom$PLATELETS)
ggplot(data = admission_lab.NArandom, aes(PLATELETS)) + geom_histogram()
```

**How many readings available at each readmission times?**

## group membership

### WBC
```{r}
wbc.t <- cbind(patients.id, wbc.df.t)

na.percol <- vector(mode="list", length=length(pat.membership))

for (i in 1:length(pat.membership)){
  wbc.groups <- wbc.t[which(wbc.t$patients.id %in% pat.membership[[i]]),]
  na.percol[[i]] <- wbc.groups %>% select(starts_with("WBC_")) %>% 
    summarise_all(funs(sum(is.na(.))/(dim(wbc.groups)[1])))
}

```


```{r}
for (i in 1:length(pat.membership)){
  sub.percol <- data.frame(t(na.percol[[i]]))
  names(sub.percol) <- c("num_na")
  print(ggplot(data = sub.percol, aes(x=1:15, y=num_na)) + geom_line(linetype = "dashed") + geom_point() + xlab("times of admission") + ylab("% NA value")+ scale_y_continuous(breaks = seq(0, 1, 0.1)))
}
```

```{r}

```

